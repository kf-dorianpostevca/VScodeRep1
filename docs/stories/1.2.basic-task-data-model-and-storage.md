# Story 1.2: Basic Task Data Model and Storage

## Status
Ready for Review

## Story
**As a** user,
**I want** my tasks stored reliably with timestamps,
**so that** my todo data persists between CLI sessions and supports future analytics.

## Acceptance Criteria
1. SQLite database schema supports task ID, title, description, timestamps, completion status
2. Database connection and basic CRUD operations implemented with proper error handling
3. Task creation automatically captures creation timestamp
4. Task completion captures completion timestamp when marked done
5. Data integrity constraints prevent invalid task states
6. Database file created in user's home directory for persistence

## Tasks / Subtasks
- [x] Create Task data model interface and type definitions (AC: 1)
  - [x] Define Task interface with all required attributes from data model
  - [x] Create TaskCreate and TaskUpdate interfaces for data operations
  - [x] Add proper TypeScript types for dates and nullable fields
- [x] Implement SQLite database schema setup (AC: 1, 6)
  - [x] Create database schema based on architecture database-schema.md
  - [x] Add database migration system for schema management
  - [x] Ensure database file creation in user's home directory
  - [x] Add proper foreign key constraints and indexes
- [x] Implement Repository pattern for data access (AC: 2)
  - [x] Create TaskRepository interface defining CRUD operations
  - [x] Implement SQLiteTaskRepository with better-sqlite3 integration
  - [x] Add proper error handling for database operations
  - [x] Include connection management and resource cleanup
- [x] Add automatic timestamp capture (AC: 3, 4)
  - [x] Implement creation timestamp in task creation methods
  - [x] Add completion timestamp capture on task completion
  - [x] Create database trigger for automatic actual_minutes calculation
  - [x] Ensure timestamps use proper Date types and ISO format
- [x] Add data validation and integrity constraints (AC: 5)
  - [x] Implement task state validation logic
  - [x] Add input validation for task title and description length
  - [x] Create validation for time estimates and actual minutes
  - [x] Add checks preventing invalid state transitions
- [x] Write comprehensive unit tests (Testing Standards)
  - [x] Test Task data model validations and type safety
  - [x] Test TaskRepository CRUD operations with in-memory SQLite
  - [x] Test timestamp capture and calculation logic
  - [x] Test data integrity constraints and error handling
  - [x] Test database file creation in home directory

## Dev Notes

### Previous Story Insights
No previous story completed yet - this is the foundation story for data persistence.

### Data Models
**Task Model:** Core entity with UUID primary key, required title (max 200 chars), optional description (max 1000 chars), creation/completion timestamps, estimated/actual minutes, completion status boolean, and optional tags array for future categorization. [Source: architecture/data-models.md#task]

**Key Attributes:**
- id: string (UUID) - Unique identifier for CLI operations
- title: string - Required, 1-200 characters
- description: string | null - Optional, max 1000 characters
- createdAt: Date - Automatic timestamp for analytics
- completedAt: Date | null - Capture when marked complete
- estimatedMinutes: number | null - User time estimates (1-1440 minutes)
- actualMinutes: number | null - Calculated duration
- isCompleted: boolean - Status flag for filtering
- tags: string[] - Future enhancement for categorization
[Source: architecture/data-models.md#task]

### Database Schema
**SQLite Schema:** Uses better-sqlite3 driver with synchronous API for performance. Tasks table includes UUID primary key generation, length constraints on text fields, check constraints for time values, and automated triggers for actual minutes calculation. Database includes performance indexes on completion status, creation date, and completion date. [Source: architecture/database-schema.md]

**Key Schema Elements:**
- PRIMARY KEY with UUID generation: `DEFAULT (lower(hex(randomblob(16))))`
- Title validation: `CHECK (length(title) > 0 AND length(title) <= 200)`
- Time constraints: `CHECK (estimated_minutes > 0 AND estimated_minutes <= 1440)`
- Automatic actual_minutes trigger on completion timestamp update
- Performance indexes: `idx_tasks_is_completed`, `idx_tasks_created_at`, `idx_tasks_completed_at`
[Source: architecture/database-schema.md]

### Repository Pattern Implementation
**Repository Pattern:** All database operations must use Repository pattern - never access SQLite directly from services. TaskRepository interface defines CRUD operations with proper error handling and type safety. Implementation uses better-sqlite3 for synchronous operations and improved performance over node-sqlite3. [Source: architecture/coding-standards.md#critical-rules]

### File Locations
Based on monorepo structure, data access components should be located in:
- Data models: `packages/shared/src/models/Task.ts`
- Repository interfaces: `packages/shared/src/repositories/ITaskRepository.ts`
- SQLite implementation: `packages/shared/src/repositories/SQLiteTaskRepository.ts`
- Database utilities: `packages/shared/src/utils/database.ts`
[Source: architecture/source-tree.md]

### Technical Constraints
**Runtime:** Node.js 20.9.0 LTS with TypeScript 5.2.2 strict mode enabled
**Database:** SQLite 3.44.0 with better-sqlite3 9.1.0 driver for synchronous API performance
**Error Handling:** Never expose database errors to users - transform to user-friendly messages maintaining celebration-focused tone
**JSDoc Requirements:** All public functions and interfaces must include comprehensive JSDoc with @param, @returns, @throws, and @example tags
[Source: architecture/tech-stack.md, architecture/coding-standards.md#critical-rules]

### Testing
**Test Framework:** Jest 29.7.0 with TypeScript support via ts-jest
**Test Location:** Unit tests in `packages/shared/__tests__/` directory with `.test.ts` suffix
**Coverage Target:** 90% line coverage for shared package business logic
**Database Testing:** In-memory SQLite for fast test execution with isolated test databases per test suite
**Test Organization:** Factory pattern with `TaskFactory.ts` for realistic data generation
**Test Types:** Unit tests for models and repository, integration tests for cross-package database operations
[Source: architecture/test-strategy-and-standards.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-26 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - James, Full Stack Developer Agent

### Debug Log References
- Fixed TypeScript strict mode issues with definite assignment assertions
- Resolved snake_case to camelCase conversion between SQLite and JavaScript objects
- Debugged SQL parameter binding issues in update statements
- Fixed database trigger not working by implementing explicit timestamp setting in repository methods

### Completion Notes List
- All Task data model interfaces created with comprehensive JSDoc documentation
- Database schema properly migrated with UUID primary keys and constraints
- Repository pattern implemented with full CRUD operations and error handling
- Automatic timestamp capture working correctly for both creation and completion
- Data validation implemented at both database constraint and application logic levels
- Comprehensive test suite with 67 passing tests covering all functionality
- Code follows TypeScript strict mode and coding standards

### File List
**Created Files:**
- `packages/shared/src/models/Task.ts` - Core Task interface and type definitions
- `packages/shared/src/models/index.ts` - Models export file
- `packages/shared/src/repositories/ITaskRepository.ts` - Repository interface definition
- `packages/shared/src/repositories/SQLiteTaskRepository.ts` - SQLite repository implementation
- `packages/shared/src/repositories/index.ts` - Repository exports
- `packages/shared/src/utils/database.ts` - Database utilities and validation
- `packages/shared/migrations/002_update_tasks_schema.sql` - Updated database schema
- `packages/shared/__tests__/models/Task.test.ts` - Task model tests
- `packages/shared/__tests__/database/schema.test.ts` - Database schema tests
- `packages/shared/__tests__/repositories/SQLiteTaskRepository.test.ts` - Repository tests

**Modified Files:**
- `packages/shared/src/database/connection.ts` - Updated for home directory storage

## QA Results
*Results from QA Agent review will be populated here*