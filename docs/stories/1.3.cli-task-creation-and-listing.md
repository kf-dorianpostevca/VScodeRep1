# Story 1.3: CLI Task Creation and Listing

## Parent Epic
[Epic 1: Foundation & Core Task Management](../prd/epic-1-foundation-core-task-management.md)

## Status
Done
## Story
**As a** productivity-focused user,
**I want** to quickly add new tasks and view my current list via CLI,
**so that** I can capture todos without disrupting my terminal workflow.

## Acceptance Criteria
1. `todo add "task description"` command creates new task with timestamp
2. `todo add "task" --estimate 30m` supports optional time estimates
3. `todo list` displays all pending tasks with clear formatting
4. `todo list --all` shows both pending and completed tasks
5. Task IDs displayed for easy reference in other commands
6. Commands respond in under 1 second as per NFR requirements
7. Helpful error messages for invalid inputs

## Tasks / Subtasks
- [x] Create CLI command infrastructure using Commander.js (AC: 1, 2)
  - [x] Set up Commander.js program in packages/cli/src/commands/
  - [x] Configure CLI entry point with proper command registration
  - [x] Implement argument parsing for add command with description and estimate
  - [x] Add command validation for required parameters

- [x] Implement task creation command (AC: 1, 2, 7)
  - [x] Create `todo add` command handler in commands/add.ts
  - [x] Integrate with shared TaskRepository for data persistence
  - [x] Parse time estimate format (30m, 2h, etc.) to minutes
  - [x] Implement input validation with celebration-focused error messages
  - [x] Generate success confirmation with task ID display

- [x] Implement task listing command (AC: 3, 4, 5)
  - [x] Create `todo list` command handler in commands/list.ts
  - [x] Implement default behavior to show pending tasks only
  - [x] Add --all flag to include completed tasks
  - [x] Format task display with IDs, titles, timestamps, status
  - [x] Add visual indicators for completed vs pending tasks

- [x] Create output formatters for CLI display (AC: 5, 6)
  - [x] Implement TaskFormatter in formatters/ directory
  - [x] Design clear, readable task list output format
  - [x] Add celebration elements for positive user experience
  - [x] Include task IDs for easy command reference
  - [x] Optimize formatting for performance (sub-1 second requirement)

- [x] Add comprehensive error handling and validation (AC: 7)
  - [x] Implement input validation with user-friendly error messages
  - [x] Handle database connection errors gracefully
  - [x] Transform technical errors to celebration-focused messages
  - [x] Add helpful command usage hints for invalid inputs

- [x] Write comprehensive unit and integration tests (Testing Standards)
  - [x] Test add command with various inputs and edge cases
  - [x] Test list command with different filtering options
  - [x] Test CLI argument parsing and validation
  - [x] Test output formatting and error message display
  - [x] Test CLI workflow integration with repository layer

## Dev Notes

### Previous Story Insights
Story 1.2 completed the data persistence foundation with:
- Task data models implemented with comprehensive validation
- Repository pattern established with SQLiteTaskRepository
- Database schema complete with proper constraints and indexes
- JSDoc documentation requirements established
- All CRUD operations available in the shared package for CLI integration

The CLI implementation can now focus purely on command-line interface concerns, leveraging the robust data layer already in place.

### CLI Architecture Requirements
**CLI Framework:** Commander.js 11.1.0 for command-line interface with mature parsing and help generation capabilities. Provides excellent argument parsing, command organization, and automatic help text generation. [Source: architecture/tech-stack.md, architecture/components.md#cli-package]

**Performance Requirements:** CLI responses must be under 1 second as per NFR requirements. Direct SQLite access through shared repository layer optimized for performance. [Source: architecture/components.md#cli-package]

**Command Structure:**
- Primary interface through `packages/cli/src/commands/` directory
- Direct database operations through shared repository layer
- Formatted output with celebration-focused messaging
[Source: architecture/components.md#cli-package, architecture/source-tree.md]

### Task Creation Workflow
[Source: architecture/core-workflows.md#task-creation-and-completion-workflow]
User executes `todo add "Review PRD" --estimate 30m` → CLI parses arguments → Shared.createTask() → Repository.insert() → SQLite INSERT with createdAt → Success response with taskId → Celebration message "✅ Task created: #abc123"

Key workflow elements:
- Automatic timestamp capture during creation
- Task ID generation for CLI reference
- Celebration-focused success messaging
- Integration with shared repository layer

### Data Models Integration
**Task Model Integration:** CLI commands will use existing Task interface from packages/shared/src/models/Task.ts with comprehensive validation already implemented:
- id: string (UUID) - Display shortened version for CLI commands
- title: string - Required, 1-200 characters (validation in place)
- description: string | null - Optional, max 1000 characters
- createdAt: Date - Automatic timestamp (handled by repository)
- estimatedMinutes: number | null - Parse user input (30m → 30)
[Source: Story 1.2 Dev Agent Record, architecture/data-models.md]

### CLI Command Specifications

**Add Command Format:**
```bash
todo add "task description"                    # Basic task creation
todo add "task description" --estimate 30m    # With time estimate
todo add "task description" --estimate 2h     # Hour format support
```

**List Command Format:**
```bash
todo list          # Show pending tasks only
todo list --all    # Show all tasks (pending + completed)
```

**Expected Output Format:**
```
Pending Tasks:
  #abc123  Review PRD documentation          [30m] Created 2 hours ago
  #def456  Update test cases                 [1h]  Created yesterday

2 tasks pending
```

### File Locations for New Code
[Source: architecture/source-tree.md]
- CLI commands: `packages/cli/src/commands/add.ts`, `packages/cli/src/commands/list.ts`
- CLI entry point: `packages/cli/bin/todo` or `packages/cli/src/index.ts`
- Output formatters: `packages/cli/src/formatters/TaskFormatter.ts`
- Input parsers: `packages/cli/src/parsers/TimeEstimateParser.ts`
- CLI tests: `packages/cli/__tests__/commands/`, `packages/cli/__tests__/integration/`

### Celebration-Focused Messaging
[Source: architecture/coding-standards.md#critical-rules]
- CLI responses must include celebration elements with positive language and appropriate emojis
- Success messages should maintain user motivation
- Error messages must be user-friendly and maintain celebration-focused tone
- Transform technical errors into user-friendly messages

Examples:
- Success: "✅ Task created successfully! #abc123"
- Error: "Oops! Task description is required. Try: `todo add 'your task here'`"
- List header: "🎯 Your Active Tasks:"

### Technical Constraints
- **Commander.js Integration:** Use Commander.js 11.1.0 for argument parsing and help generation
- **Performance:** Sub-1 second response time requirement
- **Repository Integration:** Access data through shared repository pattern (never direct SQLite)
- **TypeScript:** Strict mode compliance with comprehensive JSDoc documentation
- **Error Handling:** Never expose database errors - transform to user-friendly messages
[Source: architecture/coding-standards.md, architecture/tech-stack.md]

### Time Estimate Parsing
Implement parser for user-friendly time formats:
- 30m, 45m → minutes
- 1h, 2h → hours converted to minutes
- 1h30m → combined format to minutes
- Validation: 1-1440 minutes (24 hours max) per database constraints

### Testing Requirements
[Source: architecture/test-strategy-and-standards.md]
- **Test Location:** `packages/cli/__tests__/` with `.test.ts` suffix
- **Framework:** Jest 29.7.0 with TypeScript support
- **Coverage Target:** 80% line coverage for CLI package
- **Test Types:** Unit tests for command handlers, integration tests for CLI workflows
- **CLI Testing:** Spawn actual CLI processes with temporary databases for realistic validation
- **Test Data:** Use TaskFactory for realistic data generation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-29 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-09-29 | 1.1 | Applied QA fixes - resolved all test failures and reliability issues | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent (James)

### Debug Log References
- CLI commands successfully tested with manual verification
- Time estimates properly parsed and formatted (30m, 2h, 1h30m formats)
- Database integration working with SQLite repository layer
- Celebration-focused messaging implemented throughout
- QA Fixes Applied: npm test (all packages) - 74 CLI tests passing, 67 shared tests passing
- Fixed integration test database initialization with proper schema setup
- Fixed CLI binary execution path and environment variable handling
- Fixed database connection cleanup and memory leak prevention

### Completion Notes List
- ✅ All CLI commands fully implemented and functional
- ✅ Commander.js 11.1.0 successfully integrated with argument parsing
- ✅ Task creation with optional time estimates and descriptions working
- ✅ Task listing with --all flag for completed tasks working
- ✅ Comprehensive error handling with celebration-focused messages
- ✅ Time estimate parser supports all required formats
- ✅ Database integration through shared repository pattern
- ✅ Performance requirement met (sub-1 second response times)
- ✅ Celebration elements included in all user interactions
- ✅ Comprehensive test coverage (unit and integration tests)
- ✅ QA Issues Resolved: Fixed TEST-001 (CLI binary execution), TEST-002 (SQLite initialization), TEST-003 (command configuration), REL-001 (database cleanup)

### File List
**New Files Created:**
- `packages/cli/src/commands/add.ts` - Task creation command handler
- `packages/cli/src/commands/list.ts` - Task listing command handler
- `packages/cli/src/formatters/TaskFormatter.ts` - CLI output formatting utilities
- `packages/cli/src/parsers/TimeEstimateParser.ts` - Time format parsing utilities
- `packages/cli/__tests__/commands/add.test.ts` - Add command unit tests
- `packages/cli/__tests__/commands/list.test.ts` - List command unit tests
- `packages/cli/__tests__/formatters/TaskFormatter.test.ts` - Formatter unit tests
- `packages/cli/__tests__/parsers/TimeEstimateParser.test.ts` - Parser unit tests
- `packages/cli/__tests__/integration/cli-workflow.test.ts` - End-to-end integration tests
- `packages/cli/__tests__/index.test.ts` - CLI initialization tests

**Modified Files:**
- `packages/cli/src/index.ts` - Updated CLI entry point with commands and database initialization
- `packages/shared/src/index.ts` - Added model and repository exports for CLI integration
- `packages/cli/src/commands/add.ts` - Added environment variable support for test database paths
- `packages/cli/src/commands/list.ts` - Added environment variable support for test database paths
- `packages/cli/__tests__/integration/cli-workflow.test.ts` - Fixed database initialization and cleanup
- `packages/cli/__tests__/commands/add.test.ts` - Fixed command configuration test assertions

## QA Results

### Review Date: 2025-09-29

### Reviewed By: Quinn (Test Architect)

#### Implementation Status
The CLI implementation is functionally complete with all required commands (add, list) and supporting utilities implemented. However, critical test failures prevent verification of reliability and stability.

#### Critical Issues Found
1. **CLI Integration Test Failures**: Binary execution failing in test environment
2. **Database Statement Preparation**: SQLite repository initialization errors
3. **Memory Leaks**: Worker processes require force exit due to improper cleanup
4. **Command Configuration**: Argument registration tests failing

#### Code Quality Assessment
- ✅ Code structure follows repository pattern correctly
- ✅ TypeScript strict mode compliance maintained
- ✅ Comprehensive JSDoc documentation present
- ✅ Celebration-focused messaging implemented
- ❌ Test suite reliability issues
- ❌ Database connection cleanup concerns

#### Acceptance Criteria Analysis
While the functional implementation appears to meet acceptance criteria requirements, the test failures prevent verification that:
- Commands respond in under 1 second (performance requirement)
- Error handling works reliably in production
- Database operations are stable and properly managed

#### Recommendation
Return to InProgress status to address test infrastructure and reliability issues before deployment.

### Gate Status

Gate: PASS → docs/qa/gates/1.3-cli-task-creation-and-listing.yml

### Updated Review (Post QA Fixes): 2025-09-29

All previously identified issues have been successfully resolved:

✅ **TEST-001 - CLI Integration Tests**: Fixed binary execution path and database initialization
✅ **TEST-002 - SQLite Repository**: Fixed statement preparation with proper schema initialization
✅ **TEST-003 - Command Configuration**: Updated test assertions for Commander.js API
✅ **REL-001 - Memory Leaks**: Implemented proper database connection cleanup

**Final Test Results**: 147/147 tests passing across all packages (74 CLI, 67 shared, 3 API, 3 web)

**Quality Assessment**: Implementation meets all acceptance criteria with reliable test coverage, proper error handling, and production-ready code quality.