/**
 * Monthly command - Generate monthly progress summary
 */

import { Command } from 'commander';
import {
  createDatabaseConnection,
  SQLiteTaskRepository,
  SQLiteMonthlySummaryRepository,
  MonthlySummaryService,
  createLogger,
} from '@intelligent-todo/shared';
import { formatMonthlySummary, formatError } from '../formatters/MonthlySummaryFormatter';

const logger = createLogger('monthly-command');

/**
 * Creates the monthly command
 * @returns Commander Command instance
 */
export function createMonthlyCommand(): Command {
  const command = new Command('monthly');

  command
    .description('Generate monthly progress summary with celebration-focused analytics ðŸŽ‰')
    .option('--month <YYYY-MM>', 'Generate summary for specific month (defaults to current)')
    .action(async (options) => {
      const db = createDatabaseConnection();

      try {
        const taskRepository = new SQLiteTaskRepository(db);
        const summaryRepository = new SQLiteMonthlySummaryRepository(db);
        const service = new MonthlySummaryService(taskRepository, summaryRepository);

        // Determine month
        const targetMonth = options.month || getCurrentMonth();

        // Validate month format
        if (!/^\d{4}-\d{2}$/.test(targetMonth)) {
          throw new Error('Invalid month format. Use YYYY-MM (e.g., 2025-09)');
        }

        // Generate summary
        const summary = await service.generateMonthlySummary(targetMonth);

        // Display formatted output
        const output = formatMonthlySummary(summary);
        console.log(output);

        logger.info('Monthly summary generated', {
          month: targetMonth,
          totalTasks: summary.totalTasks,
          completionRate: summary.completionRate,
        });
      } catch (error) {
        logger.error('Monthly command failed', { error });
        console.error(formatError(error));
        process.exit(1);
      } finally {
        if (db.open) {
          db.close();
        }
      }
    });

  return command;
}

/**
 * Get current month in YYYY-MM format
 */
function getCurrentMonth(): string {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  return `${year}-${month}`;
}
